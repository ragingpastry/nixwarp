Lots of confusingly named things. Should refactor and simplify.